cd LocalPOS-new

# Clean and rebuild
rm -rf dist
npm run build

# Create packages
tar -czf bfcpos-deploy.tar.gz \
  --exclude='node_modules' \
  --exclude='.git' \
  --exclude='.env*' \
  --exclude='*.log' \
  --exclude='.DS_Store' \
  client server shared migrations scripts dist \
  package.json package-lock.json \
  tsconfig.json vite.config.ts tailwind.config.ts \
  postcss.config.js drizzle.config.ts components.json \
  deploy-bfc.sh start-bfc.sh ecosystem-bfc.config.cjs bfcpos.service nginx-bfc.conf

tar -czf bondcoffeepos-deploy.tar.gz \
  --exclude='node_modules' \
  --exclude='.git' \
  --exclude='.env*' \
  --exclude='*.log' \
  --exclude='.DS_Store' \
  client server shared migrations scripts dist \
  package.json package-lock.json \
  tsconfig.json vite.config.ts tailwind.config.ts \
  postcss.config.js drizzle.config.ts components.json \
  deploy-bondcoffee.sh start-bondcoffee.sh ecosystem-bondcoffee.config.cjs bondcoffeepos.service nginx-bondcoffee.conf

tar -czf adorapos-deploy.tar.gz \
  --exclude='node_modules' \
  --exclude='.git' \
  --exclude='.env*' \
  --exclude='*.log' \
  --exclude='.DS_Store' \
  client server shared migrations scripts dist \
  package.json package-lock.json \
  tsconfig.json vite.config.ts tailwind.config.ts \
  postcss.config.js drizzle.config.ts components.json \
  deploy-adora.sh start-adora.sh ecosystem-adora.config.cjs adorapos.service nginx-adora.conf SETUP_ADORA_POS.sh

# Upload
scp -i "C:\Users\Mike Samuel\Downloads\adora-server-key.pem" bfcpos-deploy.tar.gz ubuntu@ec2-13-214-145-23.ap-southeast-1.compute.amazonaws.com:/tmp/
scp -i "C:\Users\Mike Samuel\Downloads\adora-server-key.pem" bondcoffeepos-deploy.tar.gz ubuntu@ec2-13-214-145-23.ap-southeast-1.compute.amazonaws.com:/tmp/
scp -i "C:\Users\Mike Samuel\Downloads\adora-server-key.pem" adorapos-deploy.tar.gz ubuntu@ec2-13-214-145-23.ap-southeast-1.compute.amazonaws.com:/tmp/

# Deploy BFC POS
cd /var/www/bfcpos
sudo tar -xzf /tmp/bfcpos-deploy.tar.gz -C /var/www/bfcpos --overwrite
# Rename ecosystem config file
sudo mv /var/www/bfcpos/ecosystem-bfc.config.cjs /var/www/bfcpos/ecosystem.config.cjs 2>/dev/null || true
# Rename start script
sudo mv /var/www/bfcpos/start-bfc.sh /var/www/bfcpos/start.sh 2>/dev/null || true
# Fix PM2 path in start.sh if needed
sudo sed -i 's|/home/nodejs/node_modules/.bin/pm2-runtime|/usr/bin/pm2-runtime|g' /var/www/bfcpos/start.sh 2>/dev/null || true
sudo chmod +x /var/www/bfcpos/start.sh 2>/dev/null || true
sudo chown -R nodejs:nodejs /var/www/bfcpos
# Install dependencies and build if needed
sudo -u nodejs bash -c "cd /var/www/bfcpos && npm install --production --no-audit --no-fund" || sudo -u nodejs bash -c "cd /var/www/bfcpos && npm ci --production --no-audit --no-fund"
sudo systemctl restart bfcpos

# Deploy Bond Coffee POS
cd /var/www/bondcoffeepos
sudo tar -xzf /tmp/bondcoffeepos-deploy.tar.gz -C /var/www/bondcoffeepos --overwrite
# Rename ecosystem config file
sudo mv /var/www/bondcoffeepos/ecosystem-bondcoffee.config.cjs /var/www/bondcoffeepos/ecosystem.config.cjs 2>/dev/null || true
# Rename start script
sudo mv /var/www/bondcoffeepos/start-bondcoffee.sh /var/www/bondcoffeepos/start.sh 2>/dev/null || true
# Fix PM2 path in start.sh if needed
sudo sed -i 's|/home/nodejs/node_modules/.bin/pm2-runtime|/usr/bin/pm2-runtime|g' /var/www/bondcoffeepos/start.sh 2>/dev/null || true
sudo chmod +x /var/www/bondcoffeepos/start.sh 2>/dev/null || true
sudo chown -R nodejs:nodejs /var/www/bondcoffeepos
# Install dependencies and build if needed
sudo -u nodejs bash -c "cd /var/www/bondcoffeepos && npm install --production --no-audit --no-fund" || sudo -u nodejs bash -c "cd /var/www/bondcoffeepos && npm ci --production --no-audit --no-fund"
sudo systemctl restart bondcoffeepos

# Wait a moment for services to start
sleep 5

# Verify both services are running
curl http://localhost:7000/health
curl http://localhost:8000/health

# Check service status
sudo systemctl status bfcpos bondcoffeepos

# Fix existing due orders without customers
echo "Fixing due orders for BFC POS..."
cd /var/www/bfcpos
sudo -u nodejs bash -c "source .env.production && npm run db:fix-due-orders" || echo "No due orders to fix"

echo "Fixing due orders for Bond Coffee POS..."
cd /var/www/bondcoffeepos
sudo -u nodejs bash -c "source .env.production && npm run db:fix-due-orders" || echo "No due orders to fix"

# Deploy Adora POS (First Time Setup)
cd /var/www
sudo mkdir -p adorapos
sudo tar -xzf /tmp/adorapos-deploy.tar.gz -C /var/www/adorapos --overwrite
sudo chmod +x /var/www/adorapos/SETUP_ADORA_POS.sh
sudo /var/www/adorapos/SETUP_ADORA_POS.sh

# Deploy Adora POS (Regular Deployment)
cd /var/www/adorapos
sudo tar -xzf /tmp/adorapos-deploy.tar.gz -C /var/www/adorapos --overwrite
# Rename ecosystem config file
sudo mv /var/www/adorapos/ecosystem-adora.config.cjs /var/www/adorapos/ecosystem.config.cjs 2>/dev/null || true
# Rename start script
sudo mv /var/www/adorapos/start-adora.sh /var/www/adorapos/start.sh 2>/dev/null || true
# Fix PM2 path in start.sh if needed
sudo sed -i 's|/home/nodejs/node_modules/.bin/pm2-runtime|/usr/bin/pm2-runtime|g' /var/www/adorapos/start.sh 2>/dev/null || true
sudo chmod +x /var/www/adorapos/start.sh 2>/dev/null || true
sudo chown -R nodejs:nodejs /var/www/adorapos
# Install dependencies and build if needed
sudo -u nodejs bash -c "cd /var/www/adorapos && npm install --production --no-audit --no-fund" || sudo -u nodejs bash -c "cd /var/www/adorapos && npm ci --production --no-audit --no-fund"
# Run migrations (first time only)
sudo -u nodejs bash -c "cd /var/www/adorapos && source .env.production && npm run db:migrate" || echo "Migrations already run or failed"
sudo systemctl restart adorapos

# Wait a moment for services to start
sleep 5

# Verify all services are running
curl http://localhost:7000/health
curl http://localhost:8000/health
curl http://localhost:9000/health

# Check service status
sudo systemctl status bfcpos bondcoffeepos adorapos

# Fix existing due orders without customers
echo "Fixing due orders for BFC POS..."
cd /var/www/bfcpos
sudo -u nodejs bash -c "source .env.production && npm run db:fix-due-orders" || echo "No due orders to fix"

echo "Fixing due orders for Bond Coffee POS..."
cd /var/www/bondcoffeepos
sudo -u nodejs bash -c "source .env.production && npm run db:fix-due-orders" || echo "No due orders to fix"

echo "Fixing due orders for Adora POS..."
cd /var/www/adorapos
sudo -u nodejs bash -c "source .env.production && npm run db:fix-due-orders" || echo "No due orders to fix"

# If there are any errors, check the logs
sudo journalctl -u bfcpos -n 30 --no-pager
sudo journalctl -u bondcoffeepos -n 30 --no-pager
sudo journalctl -u adorapos -n 30 --no-pager